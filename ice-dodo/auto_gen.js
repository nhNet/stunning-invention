/* Copyright Jason (Seojoon) Yeon Â© 2021 */
var boot={preload:async function(){console.log("deployment"),await deployment.init(),console.log("sync"),await sync.init(),console.log("guardian"),await guardian.init(),console.log("tabs"),await tabs.init(),await sleep(120),console.log("start"),await start.init(),console.log("decorations"),await decorations.init(),console.log("maker"),await maker.init(),console.log("audio"),await audio.init(),console.log("leaderboard"),await leaderboard.init(),console.log("show popup"),await popup.show(),console.log("create_scene"),await start.create_scene(),console.log("update"),await update.init(),console.log("add_particle_system"),await decorations.add_particle_system(),console.log("add_skybox"),await decorations.add_skybox(),console.log("controls"),await controls.init(),console.log("preload done")},init:async function(){console.log("loader"),await loader.init(),console.log("map init"),await map.init(),console.log("map post proc"),await map.post(),console.log("spawn"),await change_state.spawn(),console.log("play"),await audio.play(),console.log("screen"),await screen.init(),console.log("all done"),transitioning=!1,await size.ingame(),console.log("map leader"),await leaderboard.update(),await leaderboard.speedrun_on_open_map()}};function sleep(t){return new Promise(e=>setTimeout(e,t))}$("document").ready(function(){boot.preload()});var audio={init:function(){this.load("assets/music/env2.mp3")},load:function(e){var t=$("#audio")[0];$("#audiosource").attr("src",e),t.load()},play:function(){var e;"on"===settings.musicEnabled&&((e=$("#audio")[0]).oncanplaythrough=e.play(),e.currentTime=0)},stop:function(){"on"===settings.musicEnabled&&document.getElementById("audio").pause()}},ads={first:!0,refresh:function(){0==deployment.is_chrome_ext&&1==$("#ad_left").length&&1==$("#ad_right").length&&(ads.first?ads.first=!1:aiptag&&aiptag.cmd&&aiptag.cmd.display&&(aiptag.cmd.display.push(function(){aipDisplayTag.display("onionfist-com_300x600_3")}),aiptag.cmd.display.push(function(){aipDisplayTag.display("onionfist-com_300x600_4")})),window.innerWidth-600<350?($("#ad_left").hide(),$("#ad_right").hide()):($("#ad_left").show(),$("#ad_right").show()))}},change_state={die:function(){alive&&(alive=!1,$("#screen").css("visibility","visible"),$("#left").animate({opacity:0},400),$("#right").animate({opacity:0},400),audio.stop(),"on"===settings.autoRestart&&(transitioning=!0,setTimeout(function(){transitioning=!1,$("#restart").click()},200)),leaderboard.set_fps())},spawn:function(){alive||(alive=!0,stats.score=0,$("#screen").css("visibility","hidden"),$("#left").animate({opacity:1},400),$("#right").animate({opacity:1},400),player.rotationQuaternion=BABYLON.Quaternion.RotationAxis(new BABYLON.Vector3(0,0,0),0),player.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(0,0,0)),player.physicsImpostor.setAngularVelocity(new BABYLON.Quaternion(0,1,0,0)),player.position=new BABYLON.Vector3(map.spawn[0],map.spawn[1],map.spawn[2]),player.rotation=new BABYLON.Vector3(0,0,0),radius=default_radius,speed=default_speed,steer=default_steer,update.set_gravity(default_gravity),alive=!(rotation=0),controls.left=!1,controls.right=!1,map.reset(),audio.play())},win:function(){if(alive&&!transitioning){alive=!(transitioning=!0),audio.stop(),cleanup.run();let n=settings.map_id;leaderboard.set_record(),sync.get(n,function(e){var t=0;null!=e&&(t=Number(e)),sync.set(n,Number(t)+1,function(){screen.set_dialog("Map Complete","#56e04c"),$("#restart").html("NEXT LEVEL"),$("#screen").css("visibility","visible"),$("#left").animate({opacity:0},400),$("#right").animate({opacity:0},400),transitioning=!1})})}}},controls={left:!1,right:!1,add_mobile:!0,buttons_hidden:!1,support_mobile:!1,init:function(){this.support_mobile&&"no"==localStorage.getItem("add_mobile")&&(controls.include_mobile=!1),"chrome_ext"===settings.interface?(this.bind_keys(),this.hide_buttons()):(this.bind_keys(),controls.add_mobile&&controls.support_mobile?this.bind_buttons():this.hide_buttons())},count_button_presses:function(){alive&&(stats.button_time+=1)},count_key_presses:function(){alive&&(stats.key_time+=1,16<stats.key_time&&this.hide_buttons())},hide_buttons:function(){0==this.buttons_hidden&&(this.buttons_hidden=!0,$("#left").hide(),$("#right").hide(),localStorage.setItem("add_mobile","no"),this.include_mobile=!1)},bind_buttons:function(){$("#left").mousedown(function(){controls.left=!0,controls.right=!1,controls.count_button_presses()}),$("#right").mousedown(function(){controls.right=!0,controls.left=!1,controls.count_button_presses()}),$("#left").mouseup(function(){controls.left=!1}),$("#right").mouseup(function(){controls.right=!1})},bind_keys:function(){document.onkeydown=function(e){37!=e.keyCode&&65!=e.keyCode||(controls.left=!0,controls.right=!1,controls.count_key_presses()),39!=e.keyCode&&68!=e.keyCode||(controls.right=!0,controls.left=!1,controls.count_key_presses()),32==e.keyCode&&(alive||$("#restart").click())},document.onkeyup=function(e){37!=e.keyCode&&65!=e.keyCode||(controls.left=!1),39!=e.keyCode&&68!=e.keyCode||(controls.right=!1)}}},cup_info={ice:{name:"Ice Cup",desc:"Fun maps for starters.",color:"#41B3BF"},cone:{name:"Cone Cup",color:"#F2A057"},fire:{name:"Fire Cup",color:"#F24949"}},guardian={init:function(){deployment.is_chrome_ext?(this.chrx(),chrome.runtime.setUninstallURL("https://forms.gle/jUFzghwpdr3NJWmN7")):this.web(),0==deployment.is_jason&&document.addEventListener("contextmenu",e=>e.preventDefault())},chrx:function(){var e;-1==["jhidcpailhmpjpbdbhceiaeeggkalgmd","acnnebgnkeafggjdplpliplippgcmfpc"].indexOf(chrome.runtime.id)&&Math.random()<.03&&(e="https://www.onionfist.com/icecopycat?rtid="+chrome.runtime.id,window.open(e,"_blank").focus())},web:function(){}};console.log("yolo");var loader={init:function(){return new Promise(t=>{var e=settings.map_id;this.load_map("maps/"+e+".js",e=>t(e))})},load_map:function(e,t){this.loadScript(e,function(){setTimeout(function(){t("done")},200)})},loadScript:function(e,t){var n=document.getElementsByTagName("head")[0],i=document.createElement("script");i.type="text/javascript",i.src=e,i.onreadystatechange=t,i.onload=t,n.appendChild(i)}},leaderboard={dodo_score:0,incomplete_maps:0,total_completes:0,num_maps_total:0,num_maps_processed:0,hash_text:"",unique:"",init:function(){$("#name_error").hide(),this.get_unique(function(){}),sync.get("NAME",function(e){console.log("Got name",e),$("#mem_name").val(e)}),$("#mem_name").on("change keyup paste",function(){let e=$("#mem_name").val().trim();console.log("new_name",e),leaderboard.check_valid_name(e)&&(leaderboard.update(),sync.set("NAME",e,function(){console.log("saved new_name",e)}))})},get_unique:function(t){sync.get("UNIQUE2",function(e){null!=e?(leaderboard.unique=e,t()):(leaderboard.unique=Math.floor(Math.random()*Math.floor(Math.random()*Date.now())*99),sync.set("UNIQUE2",leaderboard.unique,t))})},update:function(){this.dodo_score=0,this.incomplete_maps=0,this.total_completes=0,this.num_maps_total=0,this.num_maps_processed=0,this.hash_text="";var e=map_info.ice.concat(map_info.cone,map_info.fire);this.num_maps_total=e.length;for(var t=0;t<this.num_maps_total;t++){var n=e[t];this.process_map(n)}},process_map(o){sync.get(o.id,function(e){var n=Number(o.diff),i=0;null!=e&&(i=Number(e)),sync.get(o.id+"-tim",function(t){sync.get(o.id+"-fps",function(e){leaderboard.dodo_score+=i*n,0<i?leaderboard.total_completes+=i:0==i&&(leaderboard.incomplete_maps+=1),t&&0<t||(t=0),leaderboard.hash_text+=o.id+"="+i+"&"+n+"&"+t+"&"+(e=!(e&&0<e)?0:e),leaderboard.num_maps_processed+=1,leaderboard.num_maps_processed==leaderboard.num_maps_total?leaderboard.update_GUI():leaderboard.hash_text+=","})})})},update_GUI(){if(!deployment.is_chrome_ext)return $("#map_leaderboard").remove(),$("#leaderboard_button").remove(),$("#mystats").remove(),0;this.dodo_score=Math.round(this.dodo_score),this.incomplete_maps=Math.round(this.incomplete_maps),this.total_completes=Math.round(this.total_completes),this.hash_text+="@dds="+this.dodo_score,this.hash_text+=",inc="+this.incomplete_maps,this.hash_text+=",tot="+this.total_completes,this.hash_text+=",nam="+$("#mem_name").val().trim(),this.hash_text+=",fra="+settings.frameRate,this.hash_text+=",tim="+(new Date).getTime(),this.hash_text+=",ver="+chrome.runtime.getManifest().version,""==this.unique?this.get_unique(function(){this.update_GUI_2()}):this.update_GUI_2()},update_GUI_2(){this.hash_text+=",uni="+this.unique,this.hash_text+=",rid="+chrome.runtime.id;var e="You have "+this.incomplete_maps+" maps incomplete. Scroll down. :)";$("#incomplete_maps_top").html(e),$("#dodo_score").html(this.dodo_score),$("#total_completes").html(this.total_completes),$("#incomplete_maps").html(this.incomplete_maps),console.log(this.hash_text);var t="";deployment.is_chrome_ext&&(t=btoa(this.hash_text));for(var n=0,i=0;i<t.length;i++)n+=t.charCodeAt(i)*i*String(i).charCodeAt(0);var o,e=String(("00"+(o=String(n).length)).substr(("00"+o).length-2))+String(n)+t,t="https://www.onionfist.com/iceleader?q=overall#v2="+e;console.log(t),console.log(t.length),$("#leaderboard_button").attr("href",t),settings.map_id&&(e="https://www.onionfist.com/iceleader?q="+settings.map_id+"#v2="+e,$("#map_leaderboard").attr("href",e))},set_record(){const t=settings.map_id,n=stats.score,i=t+"-tim";sync.get(i,function(e){e=e||9e14,Number(n)<Number(e)?sync.set(i,n,function(){console.log("High",t,"prev=",e,"new=",n),e<9e13&&$("#speedrun_best").text("Your Previous Best Speedrun time: "+e),$("#speedrun_now").text("Your New Best Speedrun time: "+n),leaderboard.update()}):($("#speedrun_best").text("Your Best Speedrun time: "+e),$("#speedrun_now").text("Your Recent Speedrun time: "+n))})},set_fps(){const e=settings.map_id,t=stats.fps;var n=e+"-fps";sync.set(n,t,function(){console.log("Fps",e,t)})},check_valid_name(e){function t(e){return function(e,t){const n=t.split("");for(var i=e.split(""),o=0;o<i.length;o++){var a=i[o];if(0<=n.indexOf(a)==0)return!1}return!0}(e,"._ abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890")}return t(e)?$("#name_error").hide():$("#name_error").show(),t(e)},speedrun_on_open_map(){var e;settings.map_id&&(e=settings.map_id+"-tim",sync.get(e,function(e){e&&($("#best_time").html("BEST: "+e),$("#speedrun_best").text("Your Best Speedrun time: "+e))}),$("#curr_time").html(""),$("#best_time").html(""),$("#speedrun_now").text(""),$("#speedrun_best").text(""))}},cleanup={run:function(){map={render_update:function(){},physics_update:function(){},section_update:function(){}},ending.dispose();for(var e=0;e<maker.platform_count;e++)scene.getMeshByName("P"+e).dispose();for(e=0;e<maker.cone_count;e++)scene.getMeshByName("C"+e).dispose();for(e=0;e<maker.cylinder_count;e++)scene.getMeshByName("Y"+e).dispose();cones=[],maker.platform_count=0,maker.cone_count=0,maker.cylinder_count=0}},maker={platform_count:0,cone_count:0,cylinder_count:0,root_platform_mesh:null,root_cone_mesh:null,init:function(){this.root_platform_mesh=BABYLON.Mesh.CreateBox("root_platform",1,scene),decorations.decorate_platform(this.root_platform_mesh),this.root_platform_mesh.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.root_platform_mesh.isVisible=!1,this.root_cone_mesh=BABYLON.Mesh.CreateCylinder("root_cone",1,0,1,5,1,scene,!1,BABYLON.Mesh.DEFAULTSIDE),decorations.decorate_cone(this.root_cone_mesh),this.root_cone_mesh.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.root_cone_mesh.isVisible=!1},make_platform:function(e,t,n){var i=e[0],o=e[1],a=e[2],s=t[1],r=t[0],c=t[2],d=n[0],e=n[1],t=n[2];o+=Math.random()/10;n="P"+this.platform_count,n=this.root_platform_mesh.createInstance(n);n.scaling=new BABYLON.Vector3(d,e,t),n.position=new BABYLON.Vector3(i,o,a),n.rotation=new BABYLON.Vector3(s,r,c),n.freezeWorldMatrix(),n.physicsImpostor=new BABYLON.PhysicsImpostor(n,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,restitution:0,friction:.6},scene),this.platform_count+=1},make_cone:function(e){var t=e[0],n=e[1],i=e[2],e="C"+this.cone_count,e=this.root_cone_mesh.createInstance(e);e.position=new BABYLON.Vector3(t,n,i),e.scaling.y=1.2,e.freezeWorldMatrix(),cones.push(e),this.cone_count+=1},make_ending:function(e){var t=e[0],n=e[1],e=e[2];(ending=BABYLON.Mesh.CreateCylinder("ending",2,2,2,8,1,scene,!1,BABYLON.Mesh.DEFAULTSIDE)).position=new BABYLON.Vector3(t,n,e),ending.material=decorations.materials.ending,ending.freezeWorldMatrix()},make_cylinder:function(e,t,n){var i=e[0],o=e[1],a=e[2],s=t[1],r=t[0],c=t[2],d=n[0],e=n[1],t=n[2],n=BABYLON.Mesh.CreateCylinder("Y"+this.cylinder_count,1,1,1,12,1,scene,!1,BABYLON.Mesh.DEFAULTSIDE);n.scaling=new BABYLON.Vector3(d,e,t),n.position=new BABYLON.Vector3(i,o,a),n.rotation=new BABYLON.Vector3(s,r,c),n.physicsImpostor=new BABYLON.PhysicsImpostor(n,BABYLON.PhysicsImpostor.CylinderImpostor,{mass:0,restitution:0},scene),decorations.decorate_cylinder(n),this.cylinder_count+=1},make_start:function(e){var t=e[0],n=e[1],e=e[2];this.make_platform([t,n,e+9],[0,0,0],[3,.5,14])}},deployment={is_chrome_ext:null,is_jason:null,init:function(){this.is_chrome_ext=void 0!==chrome.extension,console.log("this.is_chrome_ext",this.is_chrome_ext),this.is_chrome_ext&&(this.is_jason="acnnebgnkeafggjdplpliplippgcmfpc"==chrome.runtime.id,console.log("this.is_jason",this.is_jason))}},map_info={ice:[{name:"Welcome Map",id:"tut1",diff:"1"},{name:"Icy Path",id:"ice1",diff:"2"},{name:"Snowboarder",id:"ice2",diff:"2"},{name:"Mountain",id:"beardedbaby",diff:"2"},{name:"Scorpion",id:"scorpion",diff:"3"},{name:"Easy Drifting",id:"easydrifting",diff:"3"},{name:"Hills",id:"hills",diff:"3"},{name:"Twisted Road",id:"twistedroad",diff:"4"},{name:"Trek",id:"trek",diff:"2"}],cone:[{name:"Dangerous Zone",id:"cone3",diff:"4"},{name:"The Red Hats",id:"cone2",diff:"4"},{name:"Turning Challenge",id:"sungjoon",diff:"3"},{name:"Apartment",id:"apartment",diff:"4"},{name:"Space Test",id:"spacetest",diff:"4"},{name:"Cross Gravity",id:"crossgravity",diff:"4"},{name:"Winding Path",id:"windingpath",diff:"3"}],fire:[{name:"4D Demon Cinema",id:"cone1",diff:"5"},{name:"Conefield",id:"conefield",diff:"4"},{name:"Space Canyon",id:"spacecanyon",diff:"5"},{name:"Coney Cliffs",id:"coneycliffs",diff:"4"},{name:"Everest",id:"everest",diff:"5"}]},popup={already_clicked:!1,show:function(){this.hide();for(var e=Object.keys(map_info),t=0;t<e.length;t++){var n=e[t];this.display_cup(n)}leaderboard.update(),ads.refresh(),setTimeout(function(){$("#popup").css("visibility","visible"),$("#menu").show(),transitioning=!1,parent.postMessage("hide","*"),size.popup(),$("#inner_loading").length&&$("#inner_loading").remove()},500)},hide:function(){$("#cups").html(""),$("#popup").css("visibility","hidden"),this.already_clicked=!1},display_cup:function(e){console.log("cup_id",e);var t="<div class='cup' id='"+e+"'><div id='"+e+"_main_info'><div class='play_cup' id='"+e+"_play'>PLAY</div></div><div class='more_info' id='"+e+"_more_info'></div></div>";$("#cups").append(t),cup_info[e].map_seq=[];for(var n=map_info[e],i=0;i<n.length;i++){var o=n[i];cup_info[e].map_seq.push(o.id);var a="<div class='map' id='"+e+"_map_"+o.id+"'><h2 class='map_name'>"+o.name+"</h2></div>";$("#"+e+"_more_info").append(a),popup.display_map(e,o)}popup.post_cup(e)},post_cup:function(e){var t="<h1 class='cup_name'>"+cup_info[e].name+"</h1>";$("#"+e+"_play").click(function(){popup.click_cup(e)}),$("#"+e+"_main_info").prepend(t),$("#"+e).css({background:cup_info[e].color})},display_map:function(n,i){var e=i.id;sync.get(e,function(e){var t=0;null!=e&&(t=Number(e)),deployment.is_chrome_ext&&(e=localStorage.getItem(i.id),isNaN(e)||(t=Number(t)+Number(e))),popup.post_map(n,i,t)})},post_map:function(e,t,n){var i="done_z",o="Click to Play";1==n?(i="done_a",o="COMPLETED"):2==n?(i="done_b",o="COMPLETED TWICE"):2<n&&(i="done_c",o="COMPLETED "+n+" TIMES"),10<=n?i="done_d":100<=n&&(i="done_e");var a="<div class='map_desc'>"+("DIFFICULTY: "+t.diff)+" - "+o+"</div>",o=$("#"+e+"_map_"+t.id);o.append(a),o.addClass(i),t.exp=n,o.click(function(){popup.click_map(e,t.id)})},click_cup:function(e){if(!transitioning){for(var t=map_info[e],n=-1,i=1e6,o=0;o<t.length;o++){var a=t[o].exp;a<i&&(i=a,n=o)}var s=t[n].id;this.click_map(e,s)}},click_map:function(t,n){if(!transitioning){let e=cup_info[t].map_seq;var i=(i=e.indexOf(n))||0;settings.map_id=n,settings.map_seq=e,settings.map_ind=i,settings.cup_id=t,this.already_clicked||(this.already_clicked=!0,this.hide(),$("#menu").hide(),transitioning=!0,boot.init())}}},size={popup:function(){deployment.is_chrome_ext?($("body").css("width","340px"),$("body").css("height","600px")):($(".cup").css("width","340px"),$("body").css("width","100%"),$("body").css("height","100%"))},ingame:function(){deployment.is_chrome_ext?($("body").css("width","800px"),$("body").css("height","600px")):($("body").css("width","100%"),$("body").css("height","100%"),engine.resize())}},camera=null,light=null,player=null,ending=null,cones=[],canvas=null,engine=null,scene=null,rotation=0,alive=!1,start={init:async function(){canvas=await document.getElementById("renderCanvas"),engine=await new BABYLON.Engine(canvas,!0),scene=await new BABYLON.Scene(engine,{antialiasing:!1});var e=new BABYLON.Vector3(0,-9,0);scene.enablePhysics(e)},create_scene:function(){scene.clearColor=new BABYLON.Color4(0,0,0,1),(camera=new BABYLON.FreeCamera("camera",new BABYLON.Vector3(0,2,10),scene)).setTarget(BABYLON.Vector3.Zero()),camera.rotation.y=-3.14,camera.rotation.x=.3,camera.rotation.z=0,camera.speed=0,camera.maxZ=300,(player=BABYLON.Mesh.CreateBox("player",.5,scene)).scaling=new BABYLON.Vector3(1,.16,1),player.physicsImpostor=new BABYLON.PhysicsImpostor(player,BABYLON.PhysicsImpostor.BoxImpostor,{mass:1,restitution:1,friction:.5},scene),player.position=new BABYLON.Vector3(0,0,0),sync.get("skinName",function(e){e&&decorations.decorate_player(player,e)}),(light=new BABYLON.HemisphericLight("light",new BABYLON.Vector3(0,1,0),scene)).intensity=1}},stats={score:0,fps:50,key_time:0,button_time:0,changed_to_fixed:!1,update_fps:function(){var e=Number(engine.getFps());this.fps+=.1,this.fps>e&&(this.fps=e),this.changed_to_fixed||70<this.fps&&(console.log("AUTO FIX"),this.changed_to_fixed=!0,update.set_fixed())}},sync={init:function(){deployment.is_chrome_ext||(chrome.storage={sync:{}},chrome.storage.sync.set=function(e,t){var n=Object.keys(e);localStorage.setItem(n,e[n]),t()},chrome.storage.sync.get=function(e,t){var n=e[0],i=localStorage.getItem(n),e={};e[n]=i,t(e)})},set:function(e,t,n){var i={};i[e]=t,chrome.storage.sync.set(i,function(){n()})},get:function(t,n){chrome.storage.sync.get([t],function(e){n(e[t])})}},transitioning=!0;const default_radius=5,default_speed=.28,default_steer=.022,default_gravity=-9,physics_call_rate=4;var radius=default_radius,speed=default_speed,steer=default_steer,update={interval:null,init:function(){"fixed"===settings.frameRate?this.interval=setInterval(this.loop,1e3/60):"vsync"===settings.frameRate&&engine.runRenderLoop(this.loop),window.addEventListener("resize",function(){engine.resize()})},set_fixed:function(){engine.stopRenderLoop(this.loop),this.interval=setInterval(this.loop,1e3/60)},set_vsync:function(){clearInterval(this.interval),engine.runRenderLoop(this.loop)},loop:function(){scene.render(),update.new_frame(),stats.update_fps()},new_frame:function(){alive&&(transitioning||(stats.score+=1,$("#curr_time").html("TIME: "+stats.score),this.player_move(),map.render_update(),map.section_update(),stats.score%physics_call_rate==0&&(this.collision_check(),map.physics_update())))},collision_check:function(){(player.position.y<-20||80<player.position.y)&&(change_state.die(),screen.set_dialog("Fell To Death","#e04c4f"));for(var e=0;e<maker.cone_count;e++){var t=cones[e];if(this.are_touching(player,t,.5)){change_state.die(),screen.set_dialog("Died From Cone","#e04c4f");break}}this.are_touching(player,ending,1)&&change_state.win()},player_move:function(){var e=0;controls.right&&(e+=1),controls.left&&--e,speed!==default_speed&&(player.rotationQuaternion=BABYLON.Quaternion.RotationAxis(new BABYLON.Vector3(0,0,0),0)),rotation+=e*steer,player.rotation.y=rotation;var t=speed*Math.sin(rotation-3.14),e=speed*Math.cos(rotation-3.14);player.position.x+=t,player.position.z+=e,camera.position.x=player.position.x+radius*Math.sin(rotation),camera.position.z=player.position.z+radius*Math.cos(rotation),camera.position.y=player.position.y+2,camera.rotation.y=3.14+rotation,light.position=camera.position},are_touching:function(e,t,n){var i=e.position.z-t.position.z;if(Math.abs(i)<n){i=e.position.x-t.position.x;if(Math.abs(i)<n){t=e.position.y-t.position.y;if(Math.abs(t)<n)return!0}}return!1},set_gravity:function(e){scene.gravity=new BABYLON.Vector3(0,e,0),scene.getPhysicsEngine().setGravity(scene.gravity),player.applyGravity=!0}},decorations={materials:{},idno:0,init:function(){this.materials.invis=this.rgba_mat(0,0,0,0),this.materials.ending=this.rgba_mat(36,252,3,.5),this.bright=new BABYLON.StandardMaterial("brightmat",scene),this.bright.diffuseTexture=new BABYLON.Texture("assets/textures/bright.png",scene),this.bright.diffuseTexture.uScale=this.bright.diffuseTexture.vScale=1,this.bright.backFaceCulling=!1,this.bright.freeze(),this.dark=new BABYLON.StandardMaterial("darkmat",scene),this.dark.diffuseTexture=new BABYLON.Texture("assets/textures/dark.png",scene),this.dark.diffuseTexture.uScale=this.dark.diffuseTexture.vScale=1,this.dark.backFaceCulling=!1,this.dark.freeze(),"bright"===settings.platformTexture?this.materials.platform=this.bright:"dark"===settings.platformTexture&&(this.materials.platform=this.dark);var e=this.rgba_mat(235,50,50,1);this.materials.cone=e;e=this.rgba_mat(255,255,255,1);this.materials.player=e;e=this.rgba_mat(40,60,235,.8);this.materials.cylinder=e},decorate_platform:function(e){e.material=this.materials.platform},decorate_cylinder:function(e){e.material=this.materials.cylinder},decorate_cone:function(e){e.material=this.materials.cone},decorate_player:function(e,t){let n=new BABYLON.StandardMaterial("pmat",scene);n.diffuseTexture=new BABYLON.Texture("assets/skins/"+t+".png",scene),n.diffuseTexture.uScale=n.diffuseTexture.vScale=1,n.backFaceCulling=!1,n.freeze(),e.material=n},rgba_mat:function(e,t,n,i){this.idno+=1;var o=new BABYLON.StandardMaterial("mat"+this.idno,scene);return o.diffuseColor=new BABYLON.Color3(e/255,t/255,n/255),o.alpha=i,o.backFaceCulling=!1,o.freeze(),o},add_particle_system:function(){var e=new BABYLON.ParticleSystem("particles",2e3,scene);e.particleTexture=new BABYLON.Texture("assets/textures/flare.png",scene),e.emitter=player,e.minEmitBox=new BABYLON.Vector3(-.2,0,0),e.maxEmitBox=new BABYLON.Vector3(.2,0,0),e.color1=new BABYLON.Color4(.4,.4,1,1),e.color2=new BABYLON.Color4(.9,.5,.4,1),e.colorDead=new BABYLON.Color4(0,0,.2,.8),e.minSize=.15,e.maxSize=.4,e.minLifeTime=.3,e.maxLifeTime=.4,e.emitRate=100,e.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,e.direction1=new BABYLON.Vector3(-1,1,1),e.direction2=new BABYLON.Vector3(1,1,-1),e.minEmitPower=1,e.maxEmitPower=3,e.updateSpeed=.02,e.start()},add_skybox:function(){var e=BABYLON.Mesh.CreateBox("skyBox",110,scene),t=new BABYLON.StandardMaterial("skyBox",scene);t.backFaceCulling=!1,t.reflectionTexture=new BABYLON.Texture("assets/textures/skybox.png",scene),t.reflectionTexture.coordinatesMode=BABYLON.Texture.FIXED_EQUIRECTANGULAR_MODE,t.disableLighting=!0,e.infiniteDistance=!0,e.material=t}},screen={init:function(){this.info_start(),this.bind_buttons()},info_start:function(){$("#screen_map_name").text(map.title);var e="Made by: "+map.maker;$("#screen_map_about").html(e),$("#restart").html("RESTART")},set_dialog:function(e,t){$("#screen_dialog").text(e),$("#screen_dialog").css({color:t})},bind_buttons:function(){$("#restart").click(function(){if(!alive&&!transitioning){var e=$("#restart").html();if("RESTART"===e)change_state.spawn();else if("NEXT LEVEL"===e)for(var t=map_info[settings.cup_id],n=0;n<t.length;n++)t[n].id==settings.map_id&&(n+1<t.length?popup.click_map(settings.cup_id,t[n+1].id):popup.click_map(settings.cup_id,t[0].id))}}),$("#backtomenu").click(function(){alive||transitioning||(transitioning=!0,cleanup.run(),$("#screen").css("visibility","hidden"),popup.show())}),$("#backtomenu2").click(function(){transitioning||(transitioning=!(alive=!1),cleanup.run(),audio.stop(),$("#screen").css("visibility","hidden"),popup.show())})}},a={p:function(e,t,n){maker.make_platform(e,t,n)},c:function(e){maker.make_cone(e)},e:function(e){maker.make_ending(e)},y:function(e,t,n){maker.make_cylinder(e,t,n)},m:function(e){return scene.getMeshByName(e)}},tabs={items:["notifs","settings","discord"],unlocked_skins:[],init:function(){for(var e=0;e<this.items.length;e++){var t=this.items[e];this.handle_click(t)}$(".close_tab").click(function(){var e=$(this).parent().attr("id").split("_tab")[0];$("#"+e+"_tab").hide(),$("#"+e+"_btn").css("background","#333333"),console.log(e)}),sync.get("unlocked_skins",function(e){var t=["dodo","moon","tweet"];e||sync.set("unlocked_skins",e="dodo,moon",function(){}),tabs.unlocked_skins=e.split(",");for(var n=0;n<tabs.unlocked_skins.length;n++){let e=tabs.unlocked_skins[n];var i='<div class="select_item skinItem" id="skinName_'+e+'">';i+=e.toUpperCase()+'<br><img class="skin" src="assets/skins/'+e+'.png"></div>',$("#unlocked_skins").append(i),t.splice(t.indexOf(e),1)}for(n=0;n<t.length;n++){let e=t[n];i='<div class="select_item skinItem" id="skinName_'+e+'">';i+=e.toUpperCase()+'<br><img class="skin" src="assets/skins/'+e+'.png"></div>',$("#locked_skins").append(i),tabs.unlock_skin(e)}tabs.settings_init()})},unlock_skin:function(e){"tweet"==e&&$("#skinName_tweet").click(function(){var e;0<=tabs.unlocked_skins.indexOf("tweet")||(e=tabs.unlocked_skins.join(",")+",tweet",sync.set("unlocked_skins",e,function(){window.open("https://onionfist.com/icetweet/"),0==deployment.is_chrome_ext&&setTimeout(function(){location.reload()},100)}))})},handle_click:function(e){$("#"+e+"_btn").click(function(){console.log("CLICK"),tabs.show_item(e)})},show_item:function(e){$(".tab").hide(),$(".btn").css("background","#333333"),$("#"+e+"_tab").css("visibility","visible"),$("#"+e+"_tab").css("z-index","35"),$("#"+e+"_btn").css("background","#4d4d4d"),$("#"+e+"_tab").show()},item_init:function(e){let o=e.save_id,a=e.options,t=e.standard,n=e.onclick;const i=function(e){console.log("curr_val",e);for(var t=0;t<a.length;t++){var n=a[t],i="#"+o+"_"+n;e===n?$(i).css("background","var(--red_dark)"):$(i).css("background","black")}};sync.get(o,function(e){null==e&&(sync.set(o,t,function(){}),e=t),settings[o]=e,i(e)});for(var s=0;s<a.length;s++){let e=a[s];var r="#"+o+"_"+e;$(r).click(function(){settings[o]=e,sync.set(o,e,function(){i(e),null!==n&&n(e)})})}},settings_init:function(){for(var e=[{save_id:"musicEnabled",options:["on","off"],standard:"on",onclick:null},{save_id:"autoRestart",options:["on","off"],standard:"off",onclick:null},{save_id:"frameRate",options:["fixed","vsync"],standard:"vsync",onclick:function(e){"fixed"===e?update.set_fixed():"vsync"===e&&update.set_vsync()}},{save_id:"platformTexture",options:["bright","dark"],standard:"bright",onclick:function(e){"bright"===e?(decorations.materials.platform=decorations.bright,maker.init()):"dark"===e&&(decorations.materials.platform=decorations.dark,maker.init())}},{save_id:"skinName",options:tabs.unlocked_skins,standard:"dodo",onclick:function(e){decorations.decorate_player(player,e)}}],t=0;t<e.length;t++)this.item_init(e[t])}},settings={map_id:null,map_seq:null,map_ind:null,cup_id:null,interface:null,musicEnabled:null,autoRestart:null,frameRate:null,platformTexture:null};