<!DOCTYPE html>

<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="robots" content="noindex, nofollow"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Blade Ball</title>
<script>
	/* DISABLED REDIRECT:
if (window.self === window.top) {
	    var gLoc = window.location.pathname;
	    var gPath = gLoc.substring(0, gLoc.lastIndexOf('/'));
	    var gName = gPath.substring(gPath.lastIndexOf("/") + 1);
	    window.location.replace('../../../../' + gName + '-game/');
	}
*/
</script>
<script src="haptics.js"></script>
<style>
        * {
            padding: 0;
            margin: 0;
        }
        
        body {
            width: 100%;
            text-align: center;
        }

        canvas:focus {
            outline: none;
        }

        html, body {
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            height: 100%;
        }
        
        .bg-container {
            background-color: #1E2743;
            /*background-image: url(bg.png);*/
            height: 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-size: 300px;
        }

        #unity-canvas {
            position: absolute;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
        }

        #unity-loading-bar {
            position: absolute;
            left: 30%;
            top: 50%;
            width: 40%;
            height: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        #unity-progress-bar {
            position: absolute;
            left: 0%;
            top: 0%;
            width: 1%;
            height: 100%;
            background-color: #ccc;
            border-radius: 10px;
            transition: 400ms linear;
        }
    </style>
</head>
<body>
<div class="bg-container">
<div id="unity-loading-bar">
<div id="unity-progress-bar"></div>
</div>
</div>
<canvas id="unity-canvas"></canvas>
<script>
    const isIOs = /iPhone|iPad/i.test(navigator.userAgent);
    let myGameInstance = null;
    let player = null;
    let lb;
    let StartUnityInstance;
    let ysdk = null;
    let payments = null;
    let initGame = false;
    let nowFullAdOpen = false;

    const maxPixelRatioMobile = 2.0;
    const maxPixelRatioDesktop = 1.5;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const maxDevicePixelRatio = isMobile? maxPixelRatioMobile: maxPixelRatioDesktop;
    const pixelRatio = Math.min(window.devicePixelRatio, maxDevicePixelRatio);

    const buildUrl = "Build";
    const loaderUrl = buildUrl + "/BladeBall.loader.js";
    const config = {
        dataUrl: buildUrl + "/c860bfb9d72c8b749e2c0218b3e1c547.data",
        frameworkUrl: buildUrl + "/3d26497c958347a879b5daa748ccd0cc.js",
        codeUrl: buildUrl + "/e987b14aa6b4f7d597b1648db140dd7d.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "UNI Games",
        productName: "Blade Ball",
        productVersion: "0.0.37",
        devicePixelRatio: pixelRatio,
    };

    const canvas = document.querySelector("#unity-canvas");
    const loadingBar = document.querySelector("#unity-loading-bar");
    const progressBar = document.querySelector("#unity-progress-bar");
    
    const script = document.createElement("script");
    
    script.src = loaderUrl;
    script.onload = function () {
        StartUnityInstance = function () {
            createUnityInstance(canvas, config, function (progress) {
                progressBar.style.width = 100 * progress + "%";
            }).then(function (unityInstance) {
                loadingBar.style.display = "none";
                myGameInstance = unityInstance;
                // loadingBar.style.display = "none";
            }).catch(function (message) {
                console.log(message);
                alert(message);
            });
        };
        InitYSDK();
    };

    async function InitYSDK() {
        InitPlayer();
        StartUnityInstance();
    }

    function InitPlayer() {
        try {
            console.log("Initializing player...");
    
            // Attempt to load existing player data from localStorage
            const savedData = localStorage.getItem("playerData");
    
            if (savedData) {
                player = JSON.parse(savedData);
                console.log("Loaded existing player from localStorage:", player);
            } else {
                // Create a new player if no saved data exists
                player = {
                    id: "guest_" + Math.floor(Math.random() * 1000000),
                    name: "Guest",
                    data: {}
                };
    
                // Save immediately to localStorage
                localStorage.setItem("playerData", JSON.stringify(player));
    
                // Open IndexedDB and ensure the object store exists
                let request = indexedDB.open("GameDB", 1);
                
                request.onupgradeneeded = function(event) {
                    let db = event.target.result;
                    if (!db.objectStoreNames.contains("PlayerData")) {
                        db.createObjectStore("PlayerData", { keyPath: "id" });
                        console.log("Created 'PlayerData' object store in IndexedDB.");
                    }
                };
    
                request.onsuccess = function(event) {
                    let db = event.target.result;
                    let transaction = db.transaction(["PlayerData"], "readwrite");
                    let store = transaction.objectStore("PlayerData");
                    store.put({ id: "playerData", data: player });
                    console.log("New player saved to IndexedDB:", player);
                };
    
                console.log("New player created and saved:", player);
            }
        } catch (e) {
            console.error("Error initializing player:", e.message);
        }
    }
    
    document.addEventListener('contextmenu', event => event.preventDefault());

    function FocusGame() {
        window.focus();
        canvas.focus();
    }

    window.addEventListener('pointerdown', () => {
        FocusGame();
    });
    window.addEventListener('touchstart', () => {
        FocusGame();
    });

    document.body.appendChild(script);
</script>
</body>
</html>
